<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <link rel="stylesheet" href="/snare/mandoc.css" type="text/css" media="all"/>
  <title>SNARE.CONF(5)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">SNARE.CONF(5)</td>
    <td class="head-vol">File Formats Manual</td>
    <td class="head-rtitle">SNARE.CONF(5)</td>
  </tr>
</table>
<div class="manual-text">
<h1 class="Sh" title="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
<code class="Nm" title="Nm">snare.conf</code> &#x2014;
<div class="Nd" title="Nd">snare configuration file</div>
<h1 class="Sh" title="Sh" id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">DESCRIPTION</a></h1>
<code class="Nm" title="Nm">snare.conf</code> is the configuration file for
  <a class="Xr" title="Xr">snare(1)</a>. It consists of one or more top-level
  options and one GitHub block.
<div class="Pp"></div>
The top-level options are:
<dl class="Bl-tag">
  <dt>&#x00A0;</dt>
  <dd>&#x00A0;</dd>
  <dt><b class="Sy" title="Sy">listen =</b>
    &#x201C;<i class="Em" title="Em">address</i>&#x201D;;</dt>
  <dd>is a mandatory address and port number to listen on. The format of
      <i class="Em" title="Em">address</i> is either:
    <dl class="Bl-tag">
      <dt>&#x00A0;</dt>
      <dd>&#x00A0;</dd>
      <dt>x.x.x.x:port</dt>
      <dd>an IPv4 address and port. For example,
          &#x2018;<code class="Li">0.0.0.0:8765</code>&#x2019; will listen on
          port 8765 on for all IPv4 addresses.</dd>
      <dt>&#x00A0;</dt>
      <dd>&#x00A0;</dd>
      <dt>[x:x:x]:port</dt>
      <dd>an IPv6 address and port. For example,
          &#x2018;<code class="Li">[::]:8765</code>&#x2019; will listen on port
          8765 for all IPv4 and IPv6 addresses.</dd>
    </dl>
  </dd>
  <dt>&#x00A0;</dt>
  <dd>&#x00A0;</dd>
  <dt><b class="Sy" title="Sy">maxjobs =</b>
    <i class="Em" title="Em">int</i>;</dt>
  <dd>is an optional non-zero positive integer specifying the maximum number of
      jobs to run in parallel. Defaults to the number of CPUs in the
    machine.</dd>
  <dt>&#x00A0;</dt>
  <dd>&#x00A0;</dd>
  <dt><b class="Sy" title="Sy">user =</b>
    &#x201C;<i class="Em" title="Em">user-name</i>&#x201D;;</dt>
  <dd>is an optional username that <code class="Nm" title="Nm">snare.conf</code>
      will try and change into after it has bound to a network port. Note that
      <code class="Nm" title="Nm">snare.conf</code> will refuse to run as root
      unless <b class="Sy" title="Sy">user</b> is specified. As part of changing
      user, <code class="Nm" title="Nm">snare.conf</code>:
    <ul class="Bl-bullet">
      <li>changes its uid, euid, suid to the UID of
          <i class="Em" title="Em">user-name</i>.</li>
      <li>changes its gid, egid, sgid to the primary GID of
          <i class="Em" title="Em">user-name</i>.</li>
      <li>sets the $HOME environment variable to the home directory of
          <i class="Em" title="Em">user-name</i>.</li>
      <li>sets the $USER environment variable to
          <i class="Em" title="Em">user-name</i>.</li>
    </ul>
    <div class="Pp"></div>
    All other environment variables are passed through to commands
    unchanged.</dd>
  <dt>&#x00A0;</dt>
  <dd>&#x00A0;</dd>
  <dt><b class="Sy" title="Sy">github { ... }</b></dt>
  <dd>specifies GitHub specific options.</dd>
</dl>
<div class="Pp"></div>
A &#x2018;github&#x2019; block supports the following options:
<dl class="Bl-tag">
  <dt>&#x00A0;</dt>
  <dd>&#x00A0;</dd>
  <dt><b class="Sy" title="Sy">match</b>
    &#x201C;<i class="Em" title="Em">regex</i>&#x201D; {
    <i class="Em" title="Em">match-options }</i></dt>
  <dd>where <i class="Em" title="Em">regex</i> is a regular expression in
      <a class="Lk" title="Lk" href="https://docs.rs/regex/">Rust regex
      format</a> that must match against a &#x201C;owner/repo&#x201D; full
      repository name. If it matches, then
      <i class="Em" title="Em">match-options</i> are applied.
      &#x201C;regex&#x201D; must match against the full repository name: in
      other words, it is equivalent to <i class="Em" title="Em">^regex$</i>.
      Thus the regex &#x201C;a/b&#x201D; does not match against the full
      repository name &#x201C;a/bc&#x201D;, but the regex &#x201C;a/b.*&#x201D;
      does match against &#x201C;a/bc&#x201D;.</dd>
</dl>
<div class="Pp"></div>
A &#x2018;match&#x2019; block supports the following options:
<dl class="Bl-tag">
  <dt>&#x00A0;</dt>
  <dd>&#x00A0;</dd>
  <dt><b class="Sy" title="Sy">cmd =</b>
    &#x201C;<i class="Em" title="Em">shell-cmd</i>&#x201D;;</dt>
  <dd>optionally specifies a command to be run.
      <i class="Em" title="Em">shell-cmd</i> will be executed via
      &#x2018;<code class="Li">$SHELL -c</code>&#x2019;. The following escape
      sequences are recognised and replaced before execution:
    <dl class="Bl-tag">
      <dt>&#x00A0;</dt>
      <dd>&#x00A0;</dd>
      <dt><b class="Sy" title="Sy">%e</b></dt>
      <dd>the GitHub event type (e.g.
          &#x2018;<code class="Li">pull_request</code>&#x2019;).</dd>
      <dt>&#x00A0;</dt>
      <dd>&#x00A0;</dd>
      <dt><b class="Sy" title="Sy">%j</b></dt>
      <dd>the path to the GitHub JSON.</dd>
      <dt>&#x00A0;</dt>
      <dd>&#x00A0;</dd>
      <dt><b class="Sy" title="Sy">%o</b></dt>
      <dd>the repository owner.</dd>
      <dt>&#x00A0;</dt>
      <dd>&#x00A0;</dd>
      <dt><b class="Sy" title="Sy">%r</b></dt>
      <dd>the repository.</dd>
      <dt>&#x00A0;</dt>
      <dd>&#x00A0;</dd>
      <dt><b class="Sy" title="Sy">%%</b></dt>
      <dd>a literal &#x2018;<code class="Li">%</code>&#x2019;.</dd>
    </dl>
    Note that &#x2018;<code class="Li">%</code>&#x2019; may not be followed by
      any character other than those above.
    <div class="Pp"></div>
    The escape sequences are guaranteed to satisfy the regular expression
      &#x201C;[a-zA-Z0-9._-]+&#x201D; and not to be the strings
      &#x201C;.&#x201D; or &#x201C;..&#x201D;. This means that they are safe to
      pass as shell arguments and/or to be included in file system paths.</dd>
  <dt>&#x00A0;</dt>
  <dd>&#x00A0;</dd>
  <dt><b class="Sy" title="Sy">errorcmd =</b>
    &#x201C;<i class="Em" title="Em">shell-cmd</i>&#x201D;;</dt>
  <dd>optionally specifies a command to be run when a job exits unsuccessfully.
      <i class="Em" title="Em">shell-cmd</i> will be executed via
      &#x2018;<code class="Li">$SHELL -c</code>&#x2019;. The following escape
      sequences are recognised and replaced before execution:
    <dl class="Bl-tag">
      <dt>&#x00A0;</dt>
      <dd>&#x00A0;</dd>
      <dt><b class="Sy" title="Sy">%e</b></dt>
      <dd>the GitHub event type (e.g.
          &#x2018;<code class="Li">pull_request</code>&#x2019;).</dd>
      <dt>&#x00A0;</dt>
      <dd>&#x00A0;</dd>
      <dt><b class="Sy" title="Sy">%j</b></dt>
      <dd>the path to the GitHub JSON.</dd>
      <dt>&#x00A0;</dt>
      <dd>&#x00A0;</dd>
      <dt><b class="Sy" title="Sy">%o</b></dt>
      <dd>the repository owner.</dd>
      <dt>&#x00A0;</dt>
      <dd>&#x00A0;</dd>
      <dt><b class="Sy" title="Sy">%r</b></dt>
      <dd>the repository.</dd>
      <dt>&#x00A0;</dt>
      <dd>&#x00A0;</dd>
      <dt><b class="Sy" title="Sy">%s</b></dt>
      <dd>the path to the file containing the job's combined stderr /
        stdout.</dd>
      <dt>&#x00A0;</dt>
      <dd>&#x00A0;</dd>
      <dt><b class="Sy" title="Sy">%%</b></dt>
      <dd>a literal &#x2018;<code class="Li">%</code>&#x2019;.</dd>
    </dl>
    Note that &#x2018;<code class="Li">%</code>&#x2019; may not be followed by
      any character other than those above.
    <div class="Pp"></div>
    The escape sequences are guaranteed to satisfy the regular expression
      &#x201C;[a-zA-Z0-9._-]+&#x201D; and not to be the strings
      &#x201C;.&#x201D; or &#x201C;..&#x201D;. This means that they are safe to
      pass as shell arguments and/or to be included in file system paths.</dd>
  <dt>&#x00A0;</dt>
  <dd>&#x00A0;</dd>
  <dt><b class="Sy" title="Sy">queue =</b> (evict | parallel | sequential);</dt>
  <dd>specifies what to do when multiple requests for the same repository are
      queued at once:
    <dl class="Bl-tag">
      <dt>&#x00A0;</dt>
      <dd>&#x00A0;</dd>
      <dt><b class="Sy" title="Sy">evict</b></dt>
      <dd>only run one job for this repository at a time. Additional jobs will
          stay on the queue: if a new job comes in for that repository, it
          evicts any previously queued jobs for that repository. In other words,
          for this repository there can be at most one running job and one
          queued job at any point.</dd>
      <dt>&#x00A0;</dt>
      <dd>&#x00A0;</dd>
      <dt><b class="Sy" title="Sy">parallel</b></dt>
      <dd>run as many jobs for this repository in parallel as possible.</dd>
      <dt>&#x00A0;</dt>
      <dd>&#x00A0;</dd>
      <dt><b class="Sy" title="Sy">sequential</b></dt>
      <dd>only run one job for this repository at a time. Additional jobs will
          stay on the queue and be executed in FIFO order.</dd>
    </dl>
    <div class="Pp"></div>
    The default <b class="Sy" title="Sy">match</b> block sets this to
      <b class="Sy" title="Sy">sequential</b>, which is always safe, though at
      the possible expense of lower job throughput for any given
    repository.</dd>
  <dt>&#x00A0;</dt>
  <dd>&#x00A0;</dd>
  <dt><b class="Sy" title="Sy">secret =</b>
    &#x201C;<i class="Em" title="Em">secret</i>&#x201D;;</dt>
  <dd>is the optional GitHub secret used to sign the webhook request. This
      allows <code class="Nm" title="Nm">snare.conf</code> to tell the
      difference between genuine webhook requests and those from malfeasants.
      Although this is optional, we <i class="Em" title="Em">highly</i>
      recommend setting it in all cases. Note also that if a GitHub request is
      signed, but you have not specified a secret, then snare will return the
      request as &#x201C;unauthorised&#x201D; to remind you to use the secret at
      both ends.</dd>
  <dt>&#x00A0;</dt>
  <dd>&#x00A0;</dd>
  <dt><b class="Sy" title="Sy">timeout =</b>
    <i class="Em" title="Em">period</i>;</dt>
  <dd>specifies the elapsed time, as a positive integer, in seconds that a
      process can run before being sent SIGTERM. The default
      <b class="Sy" title="Sy">match</b> block sets this to one hour (3600
      seconds).</dd>
</dl>
<div class="Pp"></div>
<b class="Sy" title="Sy">match</b> blocks are evaluated in order from top to
  bottom with each successful match overriding previous settings. A default
  <b class="Sy" title="Sy">match</b> block is inserted before any user
  <b class="Sy" title="Sy">match</b> blocks:
<div class="Pp"></div>
<div class="Bd Bd-indent">
<pre class="Li">
match &quot;.*&quot; { 
  queue = sequential; 
  timeout = 3600; 
}
</pre>
</div>
<h1 class="Sh" title="Sh" id="EXAMPLES"><a class="permalink" href="#EXAMPLES">EXAMPLES</a></h1>
The minimal recommended <code class="Nm" title="Nm">snare.conf</code> file is as
  follows:
<div class="Pp"></div>
<div class="Bd Bd-indent">
<pre class="Li">
listen = &quot;&lt;address&gt;:&lt;port&gt;&quot;; 
github { 
  match &quot;.*&quot; { 
    cmd = &quot;/path/to/prps/%o/%r %e %j&quot;; 
    error_cmd = &quot;cat %s | mailx -s \&quot;snare error: github.com/%o/%r\&quot; someone@example.com&quot;; 
    secret = &quot;&lt;secret&gt;&quot;; 
  } 
}
</pre>
</div>
<div class="Pp"></div>
where &#x201C;/path/to/prps&#x201D; is a path to a directory where per-repo
  programs are stored. Each repository then has a unique program
  &#x201C;%o/%r&#x201D; which will be executed with two arguments: the GitHub
  event; and the path to the GitHub JSON. If a job exits unsuccessfully then an
  email will be sent to someone@example.com containing the job's comined stderr
  and stdout output (assuming that a suitable sendmail clone has been installed
  and activated).
<div class="Pp"></div>
The top-to-bottom evaluation of match blocks allow users to specify defaults
  which are only overridden for specific repositories. For example, for the
  following configuration file:
<div class="Pp"></div>
<div class="Bd Bd-indent">
<pre class="Li">
listen = &quot;&lt;address&gt;:&lt;port&gt;&quot;; 
github { 
  reposdir = &quot;&lt;path&gt;&quot;; 
  match &quot;.*&quot; { 
    cmd = &quot;/path/to/prps/%o/%r %e %j&quot;; 
    error_cmd = &quot;cat %s | mailx -s \&quot;snare error: github.com/%o/%r\&quot; abc@def.com&quot;; 
    secret = &quot;sec&quot;; 
  } 
  match &quot;a/b&quot; { 
    error_cmd = &quot;lpr %s&quot;; 
  } 
}
</pre>
</div>
<div class="Pp"></div>
the following repositories will have these settings:
<div class="Pp"></div>
<div class="Bd Bd-indent">
<pre class="Li">
a/b: 
  queue = sequential 
  timeout = 3600 
  cmd = &quot;/path/to/prps/%o/%r %e %j&quot;; 
  error_cmd = &quot;lpr %s&quot;; 
  secret = &quot;sec&quot; 
c/d: 
  queue = sequential 
  timeout = 3600 
  cmd = &quot;/path/to/prps/%o/%r %e %j&quot;; 
  error_cmd = &quot;cat %s | mailx -s \&quot;snare error: github.com/%o/%r\&quot; abc@def.com&quot;; 
  secret = &quot;sec&quot;
</pre>
</div>
<div class="Pp"></div>
The following program expects to be called with an event and a JSON path (i.e.
  &#x201C;%e %j&#x201D;) and uses shell script to send a list of commits and
  diffs to the address specified in $EMAIL on each &#x201C;push&#x201D; to
  master. It works for any public GitHub repository:
<div class="Pp"></div>
<div class="Bd Bd-indent">
<pre class="Li">
#! /bin/sh 
 
set -euf 
 
# A list of email addresses separated by spaces. 
EMAILS=&quot;someone@example.com someone.else@example.com&quot; 
# A GitHub URL either https or git. 
REPO_URL=&quot;git@github.com:owner/repo.git&quot; 
 
if [ &quot;$1&quot; != &quot;push&quot; ]; then 
    exit 0 
fi 
 
ref=`jq .ref &quot;$2&quot; | tr -d ' 
if [ &quot;$ref&quot; != &quot;refs/heads/master&quot; ]; then 
    exit 0 
fi 
 
repo_fullname=`jq .repository.full_name &quot;$2&quot; | tr -d ' 
repo_url=`jq .repository.html_url &quot;$2&quot; | tr -d ' 
before_hash=`jq .before &quot;$2&quot; | tr -d ' 
after_hash=`jq .after &quot;$2&quot; | tr -d ' 
 
git clone &quot;$REPO_URL&quot; repo 
cd repo 
for email in `echo &quot;$EMAILS&quot;`; do 
    git log --reverse -p &quot;$before_hash..$after_hash&quot; \ 
      | mail -s &quot;Push to $repo_fullname&quot; &quot;$email&quot; 
done
</pre>
</div>
<div class="Pp"></div>
where <a class="Lk" title="Lk" href="https://stedolan.github.io/jq/">jq</a> is a
  command-line JSON processor. Depending on your needs, you can make this type
  of script arbitrarily more complex and powerful (for example, not cloning
  afresh on each pull).
<div class="Pp"></div>
Note that this program is deliberately untrusting of external input: it is
  careful to quote all arguments obtained from JSON; and it uses a fixed
  directory name (&#x201C;repo&#x201D;) rather than a file name from JSON that
  might include characters (such as &#x201C;../..&#x201D;) that would cause the
  script to leak data about other parts of the file system.
<h1 class="Sh" title="Sh" id="SEE_ALSO"><a class="permalink" href="#SEE_ALSO">SEE
  ALSO</a></h1>
<a class="Xr" title="Xr">snare(1)</a>
<div class="Pp"></div>
<a class="Lk" title="Lk" href="https://developer.github.com/webhooks/">GitHub's
  webhooks documentation</a>.
<h1 class="Sh" title="Sh" id="AUTHORS"><a class="permalink" href="#AUTHORS">AUTHORS</a></h1>
<a class="Xr" title="Xr">snare(1)</a> was written by
  <span class="An" title="An">Laurence Tratt</span>
  <a class="Lk" title="Lk" href="https://tratt.net/laurie/">https://tratt.net/laurie/</a></div>
<table class="foot">
  <tr>
    <td class="foot-date">2020-02-10</td>
    <td class="foot-os">Debian</td>
  </tr>
</table>
</body>
</html>
